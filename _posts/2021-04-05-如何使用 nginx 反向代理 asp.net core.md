---
layout: post
title: å¦‚ä½•ä½¿ç”¨ nginx åå‘ä»£ç† asp.net core
categories: asp.net-core
tags: [åå‘ä»£ç†,nginx]
---

* content
{:toc}

# å‰è¨€

æœ€è¿‘åˆåŒå’å•æƒ³æå‰ç«¯é¡¹ç›®äº†ï¼Œè¿™æ¬¡æˆ‘æƒ³ç©ç©nginxåä»£asp.net coreï¼ŒæŒ‰ç…§å¾®è½¯å®˜æ–¹æ–‡æ¡£ä¸€é¡¿æ“ä½œåï¼Œè¾“å…¥åœ°å€å‘ç°æ˜¯404ï¼Œç„¶åæˆ‘å°±åˆå¼€å§‹äº†ä¸€é¡¿ç©·æŠ˜è…¾... ä¸ä»¥å‰ç¨å¾®æœ‰ç‚¹ä¸åŒçš„æ˜¯è¿™æ¬¡æŠ˜è…¾äº†å¾ˆä¹…å¾ˆä¹…æ‰è§£å†³é—®é¢˜

# é—®é¢˜æˆªå›¾

![nginxé…ç½®æ–‡ä»¶]({{ '/blog-imgs/nginx dotnet q1.png' | prepend:site.baseurl }})

![æµè§ˆå™¨å®é™…æ•ˆæœ]({{ '/blog-imgs/nginx dotnet q2.jpg' | prepend:site.baseurl }})

# è§£å†³è¿‡ç¨‹

æˆ‘é¦–å…ˆæƒ³åˆ°çš„æ˜¯åˆ°ç¾¤é‡Œé¢é—®é—®ï¼Œå¾ˆå¿«å°±æœ‰äººå›å¤æˆ‘äº†ï¼Œä¸è¿‡è¿™ä¸ªå›å¤çœ‹çš„æˆ‘äº‘é‡Œé›¾é‡Œï¼Œä»–è¯´â€œè®¾ç½®è¯·æ±‚å¤´å›ºå®šä¸ºä½ é‚£ä¸ªåœ°å€çœ‹çœ‹â€ï¼Œå…¶ä¸­çš„åœ°å€å°±æ˜¯â€localhost:5000â€œï¼Œè‡³äºè¯·æ±‚å¤´æ˜¯å“ªä¸ªå˜›æˆ‘å½“æ—¶ä¹Ÿé—®äº†ï¼Œä»–è¯´â€å¥½åƒæ˜¯host-headerä»€ä¹ˆçš„æ¥ç€ï¼Œå…·ä½“çš„æ‹¼å†™è®°ä¸å¾—â€œï¼Œç„¶åå°±æ²¡ä¸‹æ–‡äº†ï¼Œäºæ˜¯æˆ‘å°±å»æŠ˜è…¾nginxäº†ï¼ŒæŠ˜è…¾äº†å¾ˆä¹…å•¥ç”¨éƒ½æ²¡

ç¬¬äºŒå¤©ï¼Œæˆ‘æƒ³ç€æ˜¯ä¸æ˜¯è·¨åŸŸé—®é¢˜å¼„å¾—å‘¢ï¼Œç„¶åæˆ‘å°±å¿…åº”å»äº†ï¼Œä¸€é¡¿æ“ä½œä¸‹æ¥åè¿˜æ˜¯å•¥ç”¨éƒ½æ²¡ï¼Œç„¶åè¿™ä¸ªé—®é¢˜å°±è¢«æˆ‘æç½®äº†å‡ å¤©ï¼Œæ²¡åŠæ³•ï¼Œæ¯•ç«Ÿäººä¸èƒ½åœ¨ä¸€æ£µæ ‘ä¸ŠåŠæ­»

å‡ å¤©åæˆ‘çªå‘çµæ„Ÿï¼Œæƒ³ç€æ˜¯ä¸æ˜¯ç›‘å¬åœ°å€çš„é—®é¢˜ï¼Œäºæ˜¯æˆ‘åšäº†ä¸ªä¸‰æ­¥æ›²ï¼Œä¸€å‘å¸ƒï¼ŒäºŒä¿®æ”¹ç›‘å¬åœ°å€ï¼Œä¸‰ä¿®æ”¹nginxé…ç½®æ–‡ä»¶
ä¸€é¡¿æ“ä½œåï¼Œæ‰“å¼€æµè§ˆå™¨ï¼Œè¾“å…¥åœ°å€ï¼Œæ•²å›è½¦... omgï¼Œç»ˆäºä¸æ˜¯404äº†ï¼

# æ­£æ–‡

é¦–å…ˆåœ¨Setup.csé‡Œçš„Configureæ–¹æ³•åŠ å…¥å¦‚ä¸‹ä»£ç ï¼Œå¹¶ä¸”æœ€å¥½åŠ åœ¨å¼€å¤´

``` c#
app.UseForwardedHeaders(new ForwardedHeadersOptions
{
    ForwardedHeaders = ForwardedHeaders.XForwardedFor | ForwardedHeaders.XForwardedProto
});
```

ç„¶åå°±èƒ½å¤Ÿå‘å¸ƒäº†ï¼Œæ¥ç€å†é…ç½®ä¸€ä¸‹nginxï¼Œä¹Ÿæ²¡ä»€ä¹ˆå¥½é…ç½®çš„
<del>ä¸»è¦å°±æ˜¯â€œproxy_passâ€è¦è®¾ç½®ä¸ºå®é™…çš„ipåœ°å€ï¼Œä¸èƒ½ç”¨ localhostï¼Œâ€œ127.0.0.1â€ï¼Œâ€œ0.0.0.0â€ç­‰ipåœ°å€</del>

```
location / {
        proxy_pass         http://192.168.1.4:5000/;

        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection keep-alive;
        proxy_set_header   Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }
```

ç„¶åå°±æ˜¯é‡è½½äºŒè¿

``` bash
$ nginx -t
$ nginx -s reload
```

è¿™æ ·nginxå°±é…ç½®å¥½äº†

ä»¥ä¸Šä¸¤æ­¥å‚è€ƒè‡ªå¾®è½¯å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.microsoft.com/zh-cn/aspnet/core/host-and-deploy/linux-nginx?view=aspnetcore-5.0

æ¥ä¸‹æ¥å°±æ˜¯é…ç½®ç›‘å¬åœ°å€äº†ï¼Œæœ‰ä¸¤ç§æ–¹æ³•æ¥é…ç½®ï¼Œä¸€æ˜¯å‘½ä»¤è¡Œï¼ŒäºŒæ˜¯ç¯å¢ƒå˜é‡

å‘½ä»¤è¡Œ

```bash
$ dotnet <dll file> --urls "http://*:5000/"
```

ç¯å¢ƒå˜é‡

```
ASPNETCORE_URLS = http://*:5000/
```

ä»¥ä¸Šé…ç½®æ–¹æ³•å‚è€ƒè‡ªï¼šhttps://blog.walterlv.com/post/configure-urls-and-port-for-asp-dotnet.html

# 4Â·13 æ›´æ–°

è¯´æ¥æƒ­æ„§ï¼Œæˆ‘æ‰çŸ¥é“dockerå®¹å™¨é»˜è®¤ä¸èƒ½ç›´æ¥è®¿é—®å®¿ä¸»æœºçš„ç½‘ç»œï¼Œä»”ç»†æƒ³æƒ³ä¹Ÿå¯¹ï¼Œæ¯•ç«Ÿæ˜¯å®¹å™¨å•Šï¼Œå“ªèƒ½è®©ä½ éšä¾¿è®¿é—®å®¿ä¸»æœºå‘¢

é‚£ä¹ˆè¿™è·Ÿæœ¬æ–‡ç« æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Œæœ‰çš„ï¼Œå› ä¸ºæˆ‘çš„ nginx å°±æ˜¯ç”¨ docker æ¥éƒ¨ç½²çš„ ğŸ¤£

æ‰€ä»¥è¦æ€ä¹ˆè§£å†³å‘¢ï¼Œå¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠä¸Šè¿°ä¸¤ä¸ªåœ°å€æ”¹æˆâ€œhttp://172.17.0.1:5000/â€å°±è¡Œäº†

è‡³äºä¸ºå•¥è¦ç”¨è¿™ä¸ªipåœ°å€ï¼Œè¯·å‚è€ƒï¼šhttps://www.cnblogs.com/mafeng/p/11781003.html

é¡ºä¾¿å†æä¸ªé†’ï¼ŒLinuxä¸‹æŸ¥è¯¢ipé…ç½®çš„å‘½ä»¤æ˜¯â€œifconfigâ€ä¸æ˜¯â€œipconfigâ€ï¼Œåˆ«ææ··äº† ğŸ˜‚

# ç»“æœæˆªå›¾

æœ€åå†æ”¾é€ä¸€æ³¢ç»“æœå›¾

![systemdæœåŠ¡é…ç½®]({{ '/blog-imgs/nginx dotnet a1.png' | prepend:site.baseurl }})

![nginxé…ç½®]({{ '/blog-imgs/nginx dotnet a2.png' | prepend:site.baseurl }})

![æµè§ˆå™¨æˆªå›¾]({{ '/blog-imgs/nginx dotnet a3.png' | prepend:site.baseurl }})